
<p class="level0"><a name="NAME"></a><h2 class="nroffsh">NAME</h2>
<p class="level0">ucf - Update Configuration File:  preserve user changes in configuration files <a name="SYNOPSIS"></a><h2 class="nroffsh">SYNOPSIS</h2>
<p class="level0"><span Class="bold">ucf</span> 
<p class="level0"><span Class="emphasis">&lt;New File&gt;</span> <span Class="emphasis">&lt;Destination&gt;</span> 
<p class="level0"><span Class="bold">ucf</span> 
<p class="level0"><span Class="emphasis">--purge</span> <span Class="emphasis">&lt;Destination&gt;</span> <a name="DESCRIPTION"></a><h2 class="nroffsh">DESCRIPTION</h2>
<p class="level0">This utility provides a means of asking the user whether or not to accept new versions of configuration files provided by the package maintainer, with various heuristics designed to minimize interaction time. It uses debconf to interact with the user, as per Debian policy.  In the SYNOPSIS above, <span Class="emphasis">New file</span> is the configuration file as provided by the package (either shipped with the package, or generated by the maintainer scripts on the fly), and <span Class="emphasis">Destination</span> is the location (usually under /etc) where the real configuration file lives, and is potentially modified by the end user.  Since the files edited would be real files, and not symbolic links, <span Class="bold">ucf</span> follows and resolves symbolic links before acting. As far as possible, ucf attempts to preserve the ownership and permission of the <span Class="emphasis">New file</span> as it is copied to the new location. 
<p class="level0">This script attempts to provide conffile like handling for files installed under <span Class="emphasis">/etc</span> not shipped in a <span Class="bold">Debian</span> package, but handled by the postinst instead. <span Class="bold">Debian</span> policy states that files under <span Class="emphasis">/etc</span> which are configuration files <span Class="bold">must</span> preserve user changes, and this applies to files handled by maintainer scripts as well. Using <span Class="bold">ucf,</span> one may ship a bunch of default configuration files somewhere in <span Class="emphasis">/usr</span> ( <span Class="emphasis">/usr/share/&lt;pkg&gt;</span> is a good location), and maintain files in <span Class="emphasis">/etc,</span> preserving user changes and in general offering the same facilities while upgrading that <span Class="bold">dpkg</span> normally provides for <span Class="emphasis">\*(lqconffiles\*(rq</span> 
<p class="level0">Additionally, this script provides facilities for transitioning a file that had not been provided <span Class="emphasis">conffile</span> like protection to come under this schema, and attempts to minimize questions asked at install time. Indeed, the transitioning facility is better than the one offered by <span Class="bold">dpkg</span> while transitioning a file from a <span Class="emphasis">non-conffile</span> to <span Class="emphasis">conffile</span> status. The second form in the SYNOPSIS above is for purging information about the configuration file when the package is purged; and is critical for allowing smooth reinstallations. 
<p class="level0">During the course of operations, when working with configuration files, <span Class="bold">ucf</span> optionally creates copies of versions of the configuration file in question. For example, a file with the suffix <span Class="emphasis">ucf-old</span> holds the old version of a configuration file replaced by <span Class="bold">ucf.</span> Also, copies of the configuration file with the suffixes <span Class="emphasis">ucf-new</span> and <span Class="emphasis">ucf-dist</span> may be created; and the maintainer scripts should consider purging copies of the configuration file with these extensions during purge. <a name="OPTIONS"></a><h2 class="nroffsh">OPTIONS</h2>
<p class="level0">
<p class="level0"><span Class="bold">-h, --help</span> Print a short usage message 
<p class="level0"><span Class="bold">-n, --no-action</span> Dry run. Print the actions that would be taken if the script is invoked, but take no action. 
<p class="level0"><span Class="bold">-d[n], --debug=[n]</span> Set the debug level to the (optional) level <span Class="emphasis">n</span> (n defaults to 1). Please note there mist be no spaces before the optional digit n. This turns on copious debugging information. 
<p class="level0"><span Class="bold">-p, --purge</span> Removes all vestiges of the file from the state hashfile. This is required to allow a package to be reinstalled after it is purged; since otherwise, the real configuration file is removed, but it remains in the hash file; and on reinstall no action is taken, since the md5sum of the new file matches that in the hashfile.  In short, remember to use this option in the postrm for every configuration file managed by ucf when the package is being purged (assuming ucf itself exists). <span Class="emphasis">Note:</span> ucf does not actually touch the file on disk in this operation, so any file removals are still the responsibility of the calling package. 
<p class="level0"><span Class="bold">-v, --verbose</span> Make the script be very verbose about setting internal variables. 
<p class="level0"><span Class="bold">-s foo, --src-dir  foo</span> Set the source directory (historical md5sums are expected to live in files and sub directories of this directory) to foo. By default, the directory the new_file lives in is assumed to be the source directory. Setting this option overrides settings in the environment variable <span Class="bold">UCF_SOURCE_DIR,</span> and in the  configuration  file variable <span Class="bold">conf_source_dir.</span> 
<p class="level0"><span Class="bold">--sum-file  foo</span> Force the historical md5sums to be read from this file, rather than defaulting to living in the source directory.  Setting this option overrides settings in the environment variable <span Class="bold">UCF_OLD_MDSUM_FILE,</span> and in the  configuration  file variable <span Class="bold">conf_old_mdsum_file.</span> 
<p class="level0"><span Class="bold">--three-way</span> This turns on the option, during installation, for the user to be offered a chance to see a merge of the changes between old maintainer version and the new maintainer version into the local copy of the configuration file. If the user likes what they see, they can ask to have these changes merged in. This allows one to get new upstream changes merged in even while retaining local modifications to the configuration file. This is accomplished by taking the configuration file and stashing it in a cache area during registration, and using diff3 during the install (the stashed file name is a munged version of the full path of the configuration file to avoid name space clashes). <span Class="emphasis">Note</span> This option appeared in Version 0.8 of <span Class="bold">ucf,</span> which was the first version released into unstable and ultimately <span Class="bold">Sarge.</span> The version of ucf in woody does not contain this option. 
<p class="level0"><span Class="bold">--debconf-ok</span> Indicate that it is ok for <span Class="emphasis">ucf</span> to use an already running debconf instance for prompting (it has always been ok to use ucf when debconf is not running -- it shall invoke debconf as needed). Since historically maintainer scripts that used debconf and also ucf had to disable/cripple debconf before running ucf (since ucf did not prompt with debconf, and needed stdio available), ucf must be cautious when called from a maintainer script that uses debconf. This option lets it know that the maintainer script has not told debconf to stop, or redirected its stdio from debconf, or anything of the sort -- and thus it is safe to use debconf even when the script discovers that debconf is running.  Packages that call ucf with this option should take care to depend on version 0.28 or higher of ucf (the first to support use this option). 
<p class="level0"><span Class="bold">--debconf-template  foo</span> Instruct ucf to use the named multiselect debconf template instead of the normal ucf-provided debconf template.  The caller is responsible for ensuring that the named template exists and has a list of choices matching those for the default ucf template, and should set Choices-C: ${CHOICES} to ensure the returned values match those from the default template.  Note that the choices must be different according to whether the <span Class="bold">--three-way</span> option is also set. 
<p class="level0"><span Class="bold">--state-dir /path/to/dir</span> Set the state directory to /path/to/dir instead of the default <span Class="emphasis">/var/lib/ucf.</span> Used mostly for testing. <a name="USAGE"></a><h2 class="nroffsh">USAGE</h2>
<p class="level0">The most common case usage is pretty simple: a single line invocation in the postinst on configure, and another single line in the postrm to tell <span Class="bold">ucf</span> to forget about the configuration file on purge (using the  --purge option) is all that is needed (assuming ucf is still on the system). 
<p class="level0">It is recommended that you also register any file being managed by <span Class="bold">ucf</span> with the ucf registry; this associates the configuration file with the package it belongs to. This is done with a simple call to <span Class="bold">ucfr.</span> Users may then query the association between a configuration file and the package using the tool <span Class="bold">ucfq.</span> Please see the appropriate manual pages for details. 
<p class="level0">If a file maintained by maintainer scripts is being transitioned from an unprotected status to the protection afforded by the script, the maintainer can help ease the transition by reducing the questions that may be asked at installation time. Specifically, questions should not be asked if the file in question is an unmodified version that was one shipped in a previous version of this package; and the maintainer can help by telling the script about the historical md5sums that published versions of this file contained. 
<p class="level0">The way to do this is to either create a file called <span Class="bold">&lt;New file&gt;.md5sum,</span> with one md5sum on each line, (the file names you use are ignored, except for the entry named default), or create a directory, called <span Class="bold">&lt;New file&gt;.md5sum.d,</span> which should contain any number of files, each containing a single line, namely, the md5sum of a previous version of <span Class="bold">&lt;New file&gt;.</span> The names of these files are not important, with one exception: The file called default is treated specially.  For example, the author personally uses either package version numbers or release code names, like <span Class="emphasis">7.6.3,</span> or <span Class="emphasis">potato.</span> If none of the historical md5sums match, we are almost certain that either the historical record of md5sums is not complete, or the user has changed the configuration file. <a name="The"></a><h2 class="nroffsh">The default historical md5sum</h2>
<p class="level0">The exception to the rule about names mentioned earlier is that if no md5sums match, and if the file <span Class="bold">&lt;New file&gt;.md5sum.d/default</span> exists, or if there is a line corresponding to a <span Class="emphasis">default</span> file in <span Class="bold">&lt;New file&gt;.md5sum,</span> it shall be used as the default md5sum of the <span Class="emphasis">previous</span> version of the package assumed to have been installed on this machine. As you can see, unless there are limited number of previously released packages (like just one), the maintainer is also making an informed guess, but the option is provided to the maintainer. 
<p class="level0">If the file <span Class="bold">&lt;New file&gt;.md5sum,</span> or the directory <span Class="bold">&lt;New file&gt;.md5sum.d</span> does not exist, or none of the md5sums match, we test the installed <span Class="emphasis">&lt;Destination&gt;</span> file to see whether it is the same as the <span Class="emphasis">&lt;New file&gt;.</span> If not, we ask the user whether they want us to replace the file. 
<p class="level0">An additional facility is also offered: optionally, ucf can store one old version of the maintainers copy of the configuration file, and, on upgrade, calculate the changes made in the maintainers version of the configuration file, and apply that patch to the local version of the file (on user request, of course). There is also a preview facility where the user can inspect the results of such a merge, before asking the action to be taken. <a name="ENVIRONMENT"></a><h2 class="nroffsh">ENVIRONMENT VARIABLES</h2>
<p class="level0">The variable <span Class="bold">UCF_FORCE_CONFFNEW,</span> if set, forces the new file to always overwrite the installed destination file, while the variable <span Class="bold">UCF_FORCE_CONFFOLD,</span> if set silently retains the installed file. <span Class="bold">UCF_FORCE_CONFFMISS</span> is only applicable when the installed destination file does not exist (perhaps due to user removal),and forces ucf to recreate the missing file (the default behaviour is to honor the users wishes and not recreate the locally deleted file). <a name="FILES"></a><h2 class="nroffsh">FILES</h2>
<p class="level0">This script creates the file <span Class="emphasis">new_file.md5sum,</span> and it may copy the file (presumably shipped with the package) <span Class="emphasis">&lt;New file&gt;</span> to its destination, <span Class="emphasis">&lt;Destination&gt;.</span> 
<p class="level0"><span Class="emphasis">/var/lib/ucf/hashfile,</span> and <span Class="emphasis">/var/lib/ucf/hashfile.X,</span> where <span Class="emphasis">X</span> is a small integer, where previous versions of the hashfile are stored. 
<p class="level0"><span Class="emphasis">/etc/ucf.conf</span> <a name="EXAMPLES"></a><h2 class="nroffsh">EXAMPLES</h2>
<p class="level0">If the package <span Class="emphasis">foo</span> wants to use ucf to handle user interaction for configuration file <span Class="emphasis">foo.conf,</span> a version of which is provided in the package as <span Class="emphasis">/usr/share/foo/configuration,</span> a simple invocation of ucf in the post inst file is all that is needed: 
<p class="level0"><span Class="bold">ucf</span> <span Class="emphasis">/usr/share/foo/configuration</span> <span Class="emphasis">/etc/foo.conf</span> 
<p class="level0">On purge, one should tell ucf to forget about the file (see detailed examples in /usr/share/doc/ucf/examples): 
<p class="level0"><span Class="bold">ucf</span> <span Class="emphasis">--purge</span> <span Class="emphasis">/etc/foo.conf</span> Please note that purge can also be used to make ucf forget the rpevious state of the files, and when the package is next installed or updated, ucf will ask the user to replace the current cofiguration file. Do this if you want to change your decision to not update to a maintainer provided version of the configuration file. 
<p class="level0">The motivation for this script was to provide conffile like handling for start files for emacs lisp packages (for example, <span Class="emphasis">/etc/emacs21/site-start.d/50psgml-init.el</span> ) These start files are not shipped with the package, instead, they are installed during the post installation configuration phase by the script <span Class="emphasis">/usr/lib/emacsen-common/emacs-package-install $package_name.</span> 
<p class="level0">This script is meant to be invoked by the packages install script at <span Class="emphasis">/usr/lib/emacsen-common/packages/install/$package_name</span> for each flavour of installed emacsen by calling it with the proper values of new file ( <span Class="emphasis">/usr/share/emacs/site-lisp/&lt;pkg&gt;/&lt;pkg-init.el</span> ), and dest file ( <span Class="emphasis">/etc/emacs21/site-start.d/50&lt;pkg-init.el</span> ), and it should do the rest. <a name="SEE"></a><h2 class="nroffsh">SEE ALSO</h2>
<p class="level0">ucf.conf(5), ucfr(1), ucfq(1), and diff3(1). The <span Class="bold">Debian</span> Emacs policy, shipped with the package <span Class="emphasis">emacsen-common.</span> <a name="AUTHOR"></a><h2 class="nroffsh">AUTHOR</h2>
<p class="level0">This manual page was written Manoj Srivastava &lt;srivasta@debian.org&gt;, for the Debian GNU/Linux system. 